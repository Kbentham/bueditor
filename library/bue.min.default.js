// $Id$

//Merged and minified: bue.popup.js, bue.html.js, bue.preview.js, bue.imce.js, bue.misc.js
(function(E,$){BUE.popups=BUE.popups||{};BUE.popHtml='<table class="bue-popup" style="display: none;"><tbody class="bue-zero"><tr class="bue-zero"><td class="bue-zero"><div class="bue-popup-head clear-block"><div class="bue-popup-title"></div><div class="bue-popup-close">x</div></div><div class="bue-popup-body clear-block"><div class="bue-popup-content"></div></div></td></tr></tbody></table>';BUE.openPopup=function(id,title,content,effect){return BUE.createPopup(id).open(title,content,effect);};BUE.createPopup=function(id,title,content){if(BUE.popups[id]){return BUE.popups[id];}
var P=BUE.popups[id]=$html(BUE.popHtml).appendTo('body').attr('id',id).find('.bue-popup-title').html(title||'').end().find('.bue-popup-content').html(content||'').end().get(0);P.open=function(title,content,effect){var E=P.bue=BUE.active,B=E.buttons[E.bindex],pos=$(B).offset();$(P).css({left:pos.left-20,top:pos.top+10});if(typeof title!='undefined'&&title!=null){$('.bue-popup-title',P).html(title);}
if(typeof content!='undefined'&&content!=null){$('.bue-popup-content',P).html(content);}
$(P)[effect||'show']();B.pops=true;P.focus&&P.focus();return P;};P.close=function(effect){return $(P)[effect||'hide']()[0]};$('.bue-popup-close',P).click(function(){P.close()});$('.bue-popup-head',P).mousedown(function(e){var pos={X:parseInt($(P).css('left'))-e.pageX,Y:parseInt($(P).css('top'))-e.pageY};var drag=function(e){$(P).css({left:pos.X+e.pageX,top:pos.Y+e.pageY});return false;};var undrag=function(e){$(document).unbind('mousemove',drag).unbind('mouseup',undrag)};$(document).mousemove(drag).mouseup(undrag);});return P;};BUE.postprocess.unshift(function(Ed,$){if(Ed.index)return;var D=E.dialog=BUE.dialog=BUE.createPopup('bue-dialog');var foc=function(){this.blur()};var Do=D.open,Dc=D.close;D.open=function(title,content,effect){D.esp&&D.close();var E=BUE.active;E.buttonsDisabled(true);$(E.buttons[E.bindex]).addClass('stay-clicked');D.esp=E.posSelection();$(E.textArea).focus(foc);return Do(title,content,effect);};D.close=function(effect){if(!D.esp)return D;var E=D.bue;$(E.textArea).unbind('focus',foc);E.buttonsDisabled(false);$(E.buttons[E.bindex]).removeClass('stay-clicked');E==BUE.active&&E.makeSelection(D.esp.start,D.esp.end).focus();D.esp=null;return Dc(effect);};var Q=E.quickPop=BUE.quickPop=BUE.createPopup('bue-quick-pop');var Qo=Q.open,Qc=Q.close;Q.open=function(content,effect){$(document).mouseup(Q.close);return Qo(null,content,effect);};Q.close=function(){$(document).unbind('mouseup',Q.close);return Qc();};$('.bue-popup-head',Q).hide();});var $html=BUE.$html;})(BUE.instance.prototype,jQuery);(function($){BUE.html=function(tag,ihtml,attr){var A=attr||{},I=ihtml||'';var H='<'+tag;for(var i in A){H+=A[i]==null?'':' '+i+'="'+A[i]+'"';}
H+=Nc(tag)?(' />'+I):('>'+I+'</'+tag+'>');return tag?H:I;};BUE.input=function(t,n,v,a){return Html('input','',$.extend({'type':t,'name':n,'value':v||null},a));};BUE.selectbox=function(n,v,opt,attr){var opt=opt||{},H='';for(var i in opt){H+=Html('option',opt[i],{'value':i,'selected':i==v?'selected':null});}
return Html('select',H,$.extend({},attr,{'name':n}));};BUE.table=function(rows,attr){for(var R,H='',i=0;R=rows[i];i++){H+=typeof R['data']=='undefined'?BUE.trow(R):BUE.trow(R['data'],R['attr']);}
return Html('table',H,attr);};BUE.trow=function(cells,attr){for(var C,H='',i=0;C=cells[i];i++){H+=typeof C['data']=='undefined'?Html('td',C):Html('td',C['data'],C['attr']);}
return Html('tr',H,attr);};BUE.regesc=function(s){return s.replace(/([\\\^\$\*\+\?\.\(\)\[\]\{\}\|\:])/g,'\\$1');};BUE.nctag=function(s){return!s||s.search(/^(img|input|hr|br|embed)$/)>-1;};BUE.parseHtml=function(s,tag){var r=new RegExp('^<('+(tag||'[a-z][a-z0-9]*')+')([^>]*)>($|((?:.|[\r\n])*)</\\1>$)');if(!(match=s.match(r))||(!match[3]&&!Nc(match[1]))){return null;}
var tag=match[1],arr=[],attr={},match;if((arr=match[2].split('"')).length>1){for(var i=0;typeof(arr[i+1])!='undefined';i+=2){attr[arr[i].replace(/\s|\=/g,'')]=arr[i+1];}}
return{tag:tag,attributes:attr,html:match[4]};};var Html=BUE.html;var Nc=BUE.nctag;})(jQuery);eDefHTML=BUE.html;eDefInput=BUE.input;eDefSelectBox=BUE.selectbox;eDefTable=BUE.table;eDefRow=BUE.trow;eDefNoEnd=BUE.nctag;eDefRegEsc=BUE.regesc;eDefParseTag=BUE.parseHtml;eDefInputText=function(n,v,s){return BUE.input('text',n,v,{'size':s||null})};eDefInputSubmit=function(n,v){return BUE.input('submit',n,v)};(function(E,$){E.prv=function(safecheck){var E=this;if(E.prvOn){return E.prvHide();}
var safecheck=typeof safecheck=='undefined'?true:safecheck;var content=E.getContent();if(safecheck&&!(E.safeToPreview=E.safeToPreview||content.indexOf('<')==-1)){content='<div class="warning">'+Drupal.t('The preview is disabled due to previously inserted HTML code in the content. This aims to protect you from any potentially harmful code inserted by other editors or users. If you own the content, just preview an empty text to re-enable the preview.')+'</div>';}
return E.prvShow(BUE.autop(content));};E.prvShow=function(html,wrap){var E=this;var $T=$(E.textArea);var $P=E.preview?$(E.preview):$(E.preview=document.createElement('div')).addClass('preview').css({'display':'none','overflow':'auto'}).insertBefore($T);if(typeof wrap=='undefined'||wrap){html='<div class="'+(E.textArea.name=='comment'?'comment':'node')+'"><div class="content">'+html+'</div></div>';}
if(E.prvOn){$P.html(html);return E;}
$P.show().height($T.height()).width($T.width()).html(html);$T.height(1);E.buttonsDisabled(true,E.bindex);$(E.buttons[E.bindex]).addClass('stay-clicked');E.prvOn=true;return E;};E.prvHide=function(){var E=this;if(E.prvOn){var $P=$(E.preview);$(E.textArea).height($P.height());$P.hide();$(E.buttons[E.bindex]).removeClass('stay-clicked');E.buttonsDisabled(false);E.prvOn=false;}
return E;};E.prvAjax=function(){var E=this,$xM;if(E.prvOn){return E.prvHide();}
if(!($xM=$.ajaxMarkup)){return E.prvShow(Drupal.t('Preview requires <a href="http://drupal.org/project/ajax_markup">Ajax markup</a> module with proper permissions set.'));}
E.prvShow(Drupal.t('Loading...'));$xM(E.getContent(),$xM.getFormat(E.textArea),function(output,status,request){E.prvOn&&E.prvShow(status?output:output.replace(/\n/g,'<br />'));});return E;};BUE.autop=function(s){if(s==''||s.search(/\n|\r/)==-1){return s;}
var X=function(x,a,b){return x.replace(new RegExp(a,'g'),b)};var R=function(a,b){return s=X(s,a,b)};var blocks='(table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|style|script|object|input|param|p|h[1-6])';s+='\n';R('<br />\\s*<br />','\n\n');R('(<'+blocks+'[^>]*>)','\n$1');R('(</'+blocks+'>)','$1\n\n');R('\r\n|\r','\n');R('\n\n+','\n\n');R('\n?((.|\n)+?)\n\\s*\n','<p>$1</p>\n');R('\n?((.|\n)+?)$','<p>$1</p>\n');R('<p>\\s*?</p>','');R('<p>(<div[^>]*>\\s*)','$1<p>');R('<p>([^<]+)\\s*?(</(div|address|form)[^>]*>)','<p>$1</p>$2');R('<p>\\s*(</?'+blocks+'[^>]*>)\\s*</p>','$1');R('<p>(<li.+?)</p>','$1');R('<p><blockquote([^>]*)>','<blockquote$1><p>');R('</blockquote></p>','</p></blockquote>');R('<p>\\s*(</?'+blocks+'[^>]*>)','$1');R('(</?'+blocks+'[^>]*>)\\s*</p>','$1');R('<(script|style)(.|\n)*?</\\1>',function(m0){return X(m0,'\n','<PNL>')});R('(<br />)?\\s*\n','<br />\n');R('<PNL>','\n');R('(</?'+blocks+'[^>]*>)\\s*<br />','$1');R('<br />(\\s*</?(p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)','$1');if(s.indexOf('<pre')!=-1){R('(<pre(.|\n)*?>)((.|\n)*?)</pre>',function(m0,m1,m2,m3){return X(m1,'\\\\([\'\"\\\\])','$1')+X(X(X(m3,'<p>','\n'),'</p>|<br />',''),'\\\\([\'\"\\\\])','$1')+'</pre>';});}
return R('\n</p>$','</p>');};})(BUE.instance.prototype,jQuery);eDefAutoP=BUE.autop;eDefPreview=function(){BUE.active.prv()};eDefPreviewShow=function(E,s,w){E.prvShow(s,w)};eDefPreviewHide=function(E){E.prvHide()};eDefAjaxPreview=function(){BUE.active.prvAjax()};(function(E,$){var I=E.imce=BUE.imce={};$(function(){I.url=Drupal.settings.BUE.imceURL||''});I.button=function(fname,text){return I.url?'<input type="button" id="bue-imce-button" name="bib" value="'+(text||Drupal.t('Browse'))+'" onclick="BUE.imce.open(this.form.elements[\''+fname+'\'])">':'';};I.prepare=function(opt){I.ready=I.sendto=function(){};if(!opt)return;if(opt.form){I.target=opt;I.ready=I.highlightTarget;I.sendto=I.fillTarget;}
else{$.isFunction(opt.ready)&&(I.ready=opt.ready);$.isFunction(opt.sendto)&&(I.sendto=opt.sendto);}};I.open=function(opt){I.prepare(opt);if(!I.pop){var url=I.url+(I.url.indexOf('?')<0?'?':'&')+'app=bue|imceload@bueImceLoad';I.pop=BUE.openPopup('bue-imce-pop',Drupal.t('File Browser'),'<iframe src="'+url+'"></iframe>');}
else{I.pop.open();I.ready(I.win,I.pop);}
var $p=$(I.pop),$w=$(window),o=$.browser.opera;var h=(o?$w[0].innerHeight:$w.height())-$p.height(),w=$w.width()-$p.width();$p.css({'top':$w.scrollTop()+Math.max(0,h/2),'left':Math.max(0,w/2)});};I.finish=function(file,win){I.sendto(file,win,I.pop);};I.fillTarget=function(file,win,pop){var target=I.target,el=target.form.elements,val={'alt':file.name,'width':file.width,'height':file.height};target.value=file.url;for(var i in val){if(el['attr_'+i])el['attr_'+i].value=val[i];}
pop.close();target.focus();};I.highlightTarget=function(win,pop){I.win.imce.highlight(I.target.value.substr(I.target.value.lastIndexOf('/')+1));};window.bueImceLoad=function(win){(I.win=win).imce.setSendTo(Drupal.t('Send to editor'),I.finish);I.ready(win,I.pop);};})(BUE.instance.prototype,jQuery);eDefBrowseButton=function(l,f,t){return BUE.imce.button(f,t)};(function(E,$){E.wrapLines=function(a1,b1,b2,a2){var E=this,str=E.getSelection().replace(/\r\n|\r/g,'\n'),Esc=BUE.regesc;if(!str){return E.tagSelection(a1+b1,b2+a2);}
var M,R=new RegExp('^'+Esc(a1+b1)+'((.|\n)*)'+Esc(b2+a2)+'$');if(M=str.match(R)){R=new RegExp(Esc(b2)+'\n'+Esc(b1),'g');return E.replaceSelection(M[1].replace(R,'\n'));}
return E.replaceSelection(a1+b1+str.replace(/\n/g,b2+'\n'+b1)+b2+a2);};E.toggleTag=function(tag,attributes,cursor){var E=this,S=E.getSelection(),O=BUE.parseHtml(S,tag);if(O){return E.replaceSelection(O.html,cursor);}
E.replaceSelection(BUE.html(tag,S,attributes),cursor);if(!S&&!BUE.nctag(tag)){var pos=E.posSelection().end-tag.length-3;E.makeSelection(pos,pos);}
return E;};E.help=function(effect){var E=this;if(!E.helpHTML){var akey=E.ctrlKeys?'Ctrl':($.browser.mozilla?'Shift + Alt':($.browser.msie?'Alt':''));for(var B,rows=[],i=0;B=E.buttons[i];i++){rows[i]=[BUE.input(B.type,null,B.value||null,{'class':B.className,'src':B.src||null}),B.title];if(B.accessKey&&akey){rows[i][1]+=' ('+akey+' + '+B.accessKey+')';}}
E.helpHTML=BUE.table(rows,{'id':'bue-help'});}
E.quickPop.open(E.helpHTML,effect);return E;};E.tagChooser=function(tags,opt){var E=this,opt=$.extend({wrapEach:'li',wrapAll:'ul',applyTag:true,effect:'slideDown'},opt);var wa=BUE.html(opt.wrapAll||'div','',{'class':'tag-chooser'}),$wa=$html(wa);var we=BUE.html(opt.wrapEach,'',{'class':'choice'});var lnk=BUE.html('a','',{href:'#','class':'choice-link'});for(var i in tags){var data={nc:BUE.nctag(tags[i][0]),html:BUE.html(tags[i][0],tags[i][1],tags[i][2])},$lnk=$html(lnk);$lnk.html(opt.applyTag?data.html:tags[i][1]).bind('click',data,function(e){var h=e.data.html,p1=h.substr(0,h.indexOf('>')+1);e.data.nc?E.replaceSelection(p1).focus():E.tagSelection(p1,h.substr(h.lastIndexOf('<'))).focus();return false;}).appendTo($wa)[we?'wrap':'end'](we);}
E.quickPop.open($wa,opt.effect);return E;};E.tagDialog=function(tag,fields,opt){var E=this,S=E.getSelection(),O=BUE.parseHtml(S,tag)||{'attributes':{}};for(var field,rows=[],i=0,n=0;field=fields[i];i++,n++){field=fproc(field,O,S);rows[n]=[field.title,fhtml(field)];while(field.getnext&&(field=fields[++i])){rows[n][1]+=fhtml(fproc(field,O,S));}}
var opt=$.extend({title:Drupal.t('Tag editor - @tag',{'@tag':tag.toUpperCase()}),stitle:Drupal.t('OK'),validate:false,submit:function(a,b){return E.tgdSubmit(a,b)},effect:'show'},opt);var table=BUE.table(rows,{'class':'bue-tgd-table'})
var sbm=BUE.html('div',BUE.input('submit','bue_tgd_submit',opt.stitle));var $form=$html(BUE.html('form',table+sbm,{name:'bue_tgd_form',id:'bue-tgd-form'}));E.dialog.open(opt.title,$form,opt.effect);$form.submit(function(){return fsubmit(tag,this,E,opt)})[0].elements[0].focus();return E;};E.tgdSubmit=function(tag,form){var E=this,O=BUE.parseHtml(E.getSelection(),tag)||{'attributes':{}};for(var name,el,i=0;el=form.elements[i];i++){if(el.name.substr(0,5)=='attr_'){name=el.name.substr(5);if(name=='html')O.html=el.value;else O.attributes[name]=el.value.replace(/\x22/g,'&quot;').replace(/>/g,'&gt;').replace(/</g,'&lt;')||null;}}
if(typeof O.html=='string'||BUE.nctag(tag)){E.replaceSelection(BUE.html(tag,O.html,O.attributes));}
else{var h=BUE.html(tag,'',O.attributes);E.tagSelection(h.substr(0,h.length-tag.length-3),'</'+tag+'>');}
return E;};var $html=BUE.$html;var fhtml=function(f){var h=f.prefix||'';switch(f.type){case'select':h+=BUE.selectbox(f.fname,f.value,f.options||{},f.attributes);break;case'textarea':h+=BUE.html('textarea','\n'+f.value,f.attributes);break;default:h+=BUE.input('text',f.fname,f.value,f.attributes);break;}
return h+(f.suffix||'');};var fproc=function(f,O,S){f=typeof(f)=='string'?{'name':f}:f;if(f.name=='html'){f.value=typeof O.html=='string'?O.html:(S||f.value||'');}
f.value=Drupal.checkPlain(typeof O.attributes[f.name]=='string'?O.attributes[f.name]:(f.value||''));f.title=typeof f.title=='string'?f.title:f.name.substr(0,1).toUpperCase()+f.name.substr(1);f.fname='attr_'+f.name;f.attributes=$.extend({name:f.fname,id:f.fname},f.attributes);f.attributes['class']=f.required?(f.attributes['class']||'')+' required':(f.attributes['class']||null);f.type=f.value.indexOf('\n')>-1?'textarea':(f.type||'text');return f;};var fsubmit=function(tag,form,E,opt){for(var el,i=0;el=form.elements[i];i++)if($(el).is('.required')&&!el.value){$(el).fadeOut('fast',function(){$(this).fadeIn('fast').focus()});return false;}
var V=opt.validate;if(V&&$.isFunction(V)){try{if(!V(tag,form))return false}catch(e){alert(e.name+': '+e.message)};}
E.dialog.close();var S=opt.submit;S=typeof S=='string'?window[S]:S;if(S&&$.isFunction(S)){try{S(tag,form)}catch(e){alert(e.name+': '+e.message)};}
return false;};})(BUE.instance.prototype,jQuery);eDefSelProcessLines=eDefTagLines=function(a,b,c,d){BUE.active.wrapLines(a,b,c,d)};eDefTagger=function(a,b,c){BUE.active.toggleTag(a,b,c)};eDefHelp=function(fx){BUE.active.help(fx)};eDefTagDialog=function(a,b,c,d,e,f){BUE.active.tagDialog(a,b,{title:c,stitle:d,submit:e,effect:f})};eDefTagInsert=function(a,b){BUE.active.tgdSubmit(a,b)};eDefTagChooser=function(a,b,c,d,e){BUE.active.tagChooser(a,{applyTag:b,wrapEach:c,wrapAll:d,effect:e})};